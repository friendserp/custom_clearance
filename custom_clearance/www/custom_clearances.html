{% extends "templates/web.html" %}

{% block breadcrumbs %}
	{% include "templates/includes/breadcrumbs.html" %}
{% endblock %}

{% block title %}
	{% if is_detail %}{{ clearance.name }}{% else %}{{ title or _("Custom Clearances") }}{% endif %}
{% endblock %}

{% block header %}
	{% if is_detail %}
		<h3 class="m-0">{{ clearance.name }}</h3>
	{% endif %}
{% endblock %}

{% block page_content %}
{% if is_detail %}
<div class="custom-clearance-detail-page">
	<!-- Hero Header Section -->
	<div class="hero-header">
		<div class="hero-content">
			<div class="clearance-title-section">
				<h1 class="clearance-title">
					<i class="fa fa-file-text-o"></i> {{ clearance.name }}
				</h1>
				<p class="clearance-subtitle">{{ _("Custom Clearance Details") }}</p>
			</div>
			<div class="status-section">
				<div class="main-status">
					{% set status_color = "secondary" %}
					{% set status_icon = "file-text-o" %}
					{% if clearance.status == "Cleared" %}
						{% set status_color = "success" %}
						{% set status_icon = "check-circle" %}
					{% elif clearance.status == "Risk Analysis" %}
						{% set status_color = "warning" %}
						{% set status_icon = "exclamation-triangle" %}
					{% elif clearance.status == "In Review" %}
						{% set status_color = "info" %}
						{% set status_icon = "clock-o" %}
					{% elif clearance.status == "Document Submitting" %}
						{% set status_color = "secondary" %}
						{% set status_icon = "upload" %}
					{% endif %}
					<span class="status-badge badge-{{ status_color }} animated-badge">
						<i class="fa fa-{{ status_icon }}"></i> {{ clearance.status }}
					</span>
				</div>
				{% if clearance.risk_result %}
				<div class="risk-status">
					<span class="risk-label">{{ _("Risk Status") }}:</span>
					<span class="risk-badge badge-{{ 'success' if clearance.risk_result == 'Green' else 'warning' if clearance.risk_result == 'Yellow' else 'danger' }} animated-badge">
						<i class="fa fa-{{ 'shield' if clearance.risk_result == 'Green' else 'exclamation-triangle' if clearance.risk_result == 'Yellow' else 'times-circle' }}"></i> {{ clearance.risk_result }}
					</span>
				</div>
				{% endif %}
			</div>
		</div>
	</div>

	<div class="row">
		<div class="col-md-6">
			<div class="card">
				<div class="card-header">
					<h5>{{ _("Basic Information") }}</h5>
				</div>
				<div class="card-body">
					<table class="table table-borderless">
						<tr>
							<td><strong>{{ _("Customer") }}:</strong></td>
							<td>{{ customer_name or clearance.customer }}</td>
						</tr>
						<tr>
							<td><strong>{{ _("Clearance Date") }}:</strong></td>
							<td>{{ frappe.format(clearance.clearance_date, {"fieldtype": "Date"}) }}</td>
						</tr>
						<tr>
							<td><strong>{{ _("Shipping Type") }}:</strong></td>
							<td><span class="badge badge-info animated-badge">{{ clearance.shipping_type }}</span></td>
						</tr>
						<tr>
							<td><strong>{{ _("Template") }}:</strong></td>
							<td>{{ clearance.template or "-" }}</td>
						</tr>
					</table>
				</div>
			</div>
		</div>

		<div class="col-md-6">
			<div class="card">
				<div class="card-header">
					<h5>{{ _("Payment Information") }}</h5>
				</div>
				<div class="card-body">
					<table class="table table-borderless">
						<tr>
							<td><strong>{{ _("Amount") }}:</strong></td>
							<td>
								{% if clearance.amount %}
									{{ frappe.format(clearance.amount, {"fieldtype": "Currency"}) }}
								{% else %}
									-
								{% endif %}
							</td>
						</tr>
						<tr>
							<td><strong>{{ _("Payment Status") }}:</strong></td>
							<td>
								<span class="badge badge-{{ 'success' if clearance.payment_status == 'Paid' else 'warning' if clearance.payment_status == 'Partially Paid' else 'secondary' }} animated-badge">
									{{ clearance.payment_status or _("Pending") }}
								</span>
							</td>
						</tr>
						<tr>
							<td><strong>{{ _("Payment Date") }}:</strong></td>
							<td>
								{% if clearance.payment_date %}
									{{ frappe.format(clearance.payment_date, {"fieldtype": "Date"}) }}
								{% else %}
									-
								{% endif %}
							</td>
						</tr>
						{% if clearance.sales_invoice %}
						<tr>
							<td><strong>{{ _("Sales Invoice") }}:</strong></td>
							<td>
								<a href="/invoices/{{ clearance.sales_invoice }}" class="invoice-link">
									<i class="fa fa-file-invoice"></i> {{ clearance.sales_invoice }}
								</a>
							</td>
						</tr>
						{% endif %}
					</table>
				</div>
			</div>
		</div>
	</div>

	{% if clearance.risk_result or clearance.additional_payment_amount or clearance.risk_status_comment %}
	<div class="row mt-4">
		<div class="col-12">
			<div class="card risk-analysis-card">
				<div class="card-header">
					<h5><i class="fa fa-shield"></i> {{ _("Risk Analysis Information") }}</h5>
				</div>
				<div class="card-body">
					{% if clearance.risk_result %}
					<div class="info-row">
						<div class="info-label">
							<i class="fa fa-shield"></i> {{ _("Risk Result") }}
						</div>
						<div class="info-value">
							<span class="badge badge-{{ 'success' if clearance.risk_result == 'Green' else 'warning' if clearance.risk_result == 'Yellow' else 'danger' }} animated-badge">
								<i class="fa fa-{{ 'shield' if clearance.risk_result == 'Green' else 'exclamation-triangle' if clearance.risk_result == 'Yellow' else 'times-circle' }}"></i> {{ clearance.risk_result }}
							</span>
						</div>
					</div>
					{% endif %}
					{% if clearance.additional_payment_amount %}
					<div class="info-row">
						<div class="info-label">
							<i class="fa fa-money"></i> {{ _("Additional Payment Amount") }}
						</div>
						<div class="info-value highlight-amount">
							{{ frappe.format(clearance.additional_payment_amount, {"fieldtype": "Currency"}) }}
						</div>
					</div>
					{% endif %}
					{% if clearance.risk_status_comment %}
					<div class="telegram-comment-section">
						<div class="comment-header">
							<i class="fa fa-comment-o"></i> {{ _("Risk Status Comment") }}
						</div>
						<div class="telegram-message">
							<div class="message-bubble">
								<div class="message-content">
									{{ clearance.risk_status_comment }}
								</div>
								<div class="message-time">
									<i class="fa fa-clock-o"></i> {{ frappe.format(clearance.modified, {"fieldtype": "Datetime"}) if clearance.modified else "" }}
								</div>
							</div>
						</div>
					</div>
					{% endif %}
				</div>
			</div>
		</div>
	</div>
	{% endif %}

	<div class="row mt-4">
		<div class="col-12">
			<div class="card modern-card">
				<div class="card-header modern-card-header">
					<h5><i class="fa fa-file-text"></i> {{ _("Required Documents") }}</h5>
				</div>
				<div class="card-body">
					{% if required_documents %}
					<div class="table-responsive modern-table-wrapper">
						<table class="table modern-table">
							<thead>
								<tr>
									<th>{{ _("Document Name") }}</th>
									<th>{{ _("Required") }}</th>
									<th>{{ _("Sub Items") }}</th>
									<th>{{ _("Attachment") }}</th>
									<th>{{ _("Status") }}</th>
								</tr>
							</thead>
							<tbody>
								{% for doc in required_documents %}
								<tr class="document-row" data-row-name="{{ doc.name }}">
									<td>
										<strong class="document-name">{{ doc.document_name }}</strong>
									</td>
									<td>
										{% if doc.is_required %}
											<span class="badge badge-required">{{ _("Required") }}</span>
										{% else %}
											<span class="badge badge-optional">{{ _("Optional") }}</span>
										{% endif %}
									</td>
									<td>
										{% if doc.has_sub_items and doc.sub_items %}
											<span class="sub-items">{{ doc.sub_items }}</span>
										{% else %}
											<span class="text-muted">-</span>
										{% endif %}
									</td>
									<td>
										{% if doc.attachment %}
											<div class="attachment-actions">
												<a href="{{ doc.attachment }}" target="_blank" class="btn btn-view">
													<i class="fa fa-eye"></i> {{ _("View") }}
												</a>
												{% if doc.file_info %}
												<small class="file-name">{{ doc.file_info.file_name }}</small>
												{% endif %}
												{% if doc.status == "Declined" %}
												<button type="button" class="btn btn-reupload" 
													data-row-name="{{ doc.name }}"
													data-doc-name="{{ doc.document_name }}"
													data-reason="{{ doc.reason or ''|e }}"
													onclick="showReuploadModal(this)">
													<i class="fa fa-upload"></i> {{ _("Re-upload") }}
												</button>
												{% endif %}
											</div>
										{% else %}
											<div class="upload-container">
												<input type="file" 
													class="file-input" 
													id="file-{{ doc.name }}"
													data-row-name="{{ doc.name }}"
													data-clearance-name="{{ clearance.name }}"
													accept=".pdf,.doc,.docx,.jpg,.jpeg,.png,.gif,.xlsx,.xls"
													style="display: none;">
												<button type="button" 
													class="btn btn-upload"
													onclick="document.getElementById('file-{{ doc.name }}').click()">
													<i class="fa fa-cloud-upload"></i> {{ _("Upload") }}
												</button>
												<span class="upload-progress" id="progress-{{ doc.name }}" style="display: none;">
													<i class="fa fa-spinner fa-spin"></i> {{ _("Uploading...") }}
												</span>
											</div>
										{% endif %}
									</td>
									<td>
										<div class="status-container">
											{% if doc.status %}
												{% if doc.status == "Accepted" %}
													<span class="badge badge-accepted animated-badge">
														<i class="fa fa-check-circle"></i> {{ doc.status }}
													</span>
												{% elif doc.status == "Declined" %}
													<span class="badge badge-declined animated-badge">
														<i class="fa fa-times-circle"></i> {{ doc.status }}
													</span>
													{% if doc.reason %}
													<div class="decline-reason-tooltip">
														<small class="decline-reason-link" data-toggle="tooltip" data-placement="top" title="{{ doc.reason }}">
															<i class="fa fa-info-circle"></i> {{ _("View reason") }}
														</small>
													</div>
													{% endif %}
												{% elif doc.status == "In Review" %}
													<span class="badge badge-review animated-badge">
														<i class="fa fa-clock-o"></i> {{ doc.status }}
													</span>
												{% else %}
													<span class="badge badge-review animated-badge">
														<i class="fa fa-clock-o"></i> {{ doc.status }}
													</span>
												{% endif %}
											{% elif doc.attachment %}
												<span class="badge badge-attached animated-badge">
													<i class="fa fa-check"></i> {{ _("Attached") }}
												</span>
											{% elif doc.is_required %}
												<span class="badge badge-missing animated-badge">
													<i class="fa fa-exclamation-triangle"></i> {{ _("Missing") }}
												</span>
											{% else %}
												<span class="badge badge-pending animated-badge">
													<i class="fa fa-hourglass-half"></i> {{ _("Pending") }}
												</span>
											{% endif %}
										</div>
									</td>
								</tr>
								{% endfor %}
							</tbody>
						</table>
					</div>
					{% else %}
					<p class="text-muted text-center py-4">{{ _("No documents required.") }}</p>
					{% endif %}
				</div>
			</div>
		</div>
	</div>

	<!-- Re-upload Modal -->
	<div class="modal fade" id="reuploadModal" tabindex="-1" role="dialog">
		<div class="modal-dialog" role="document">
			<div class="modal-content">
				<div class="modal-header">
					<h5 class="modal-title">{{ _("Re-upload Document") }}</h5>
					<button type="button" class="close" data-dismiss="modal">
						<span>&times;</span>
					</button>
				</div>
				<div class="modal-body">
					<p><strong id="modal-doc-name"></strong></p>
					<div id="modal-decline-reason" class="alert alert-warning" style="display: none;">
						<strong>{{ _("Decline Reason:") }}</strong>
						<p id="modal-reason-text"></p>
					</div>
					<div class="form-group">
						<label>{{ _("Select new file to upload") }}</label>
						<input type="file" class="form-control-file" id="reupload-file-input" 
							accept=".pdf,.doc,.docx,.jpg,.jpeg,.png,.gif,.xlsx,.xls">
					</div>
				</div>
				<div class="modal-footer">
					<button type="button" class="btn btn-secondary" data-dismiss="modal">{{ _("Cancel") }}</button>
					<button type="button" class="btn btn-primary" id="reupload-submit-btn">
						<i class="fa fa-upload"></i> {{ _("Upload") }}
					</button>
				</div>
			</div>
		</div>
	</div>

	<div class="back-button-container">
		<div class="row">
			<div class="col-12">
				<a href="/custom_clearances" class="btn btn-secondary">
					<i class="fa fa-arrow-left"></i> {{ _("Back to List") }}
				</a>
			</div>
		</div>
	</div>
</div>

<style>
.custom-clearance-detail-page {
	padding: 0;
	animation: fadeIn 0.5s ease-in;
	min-height: 100vh;
	background: #f8f9fa;
}

@keyframes fadeIn {
	from { opacity: 0; transform: translateY(20px); }
	to { opacity: 1; transform: translateY(0); }
}

/* Hero Header Section */
.hero-header {
	background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
	padding: 40px 30px;
	margin-bottom: 30px;
	box-shadow: 0 4px 20px rgba(0,0,0,0.1);
	position: relative;
	overflow: hidden;
}

.hero-header::before {
	content: '';
	position: absolute;
	top: -50%;
	right: -50%;
	width: 200%;
	height: 200%;
	background: radial-gradient(circle, rgba(255,255,255,0.1) 0%, transparent 70%);
	animation: shimmer 8s infinite;
}

.hero-content {
	display: flex;
	justify-content: space-between;
	align-items: center;
	flex-wrap: wrap;
	gap: 20px;
	position: relative;
	z-index: 1;
}

.clearance-title-section {
	flex: 1;
	min-width: 300px;
}

.clearance-title {
	font-size: 32px;
	font-weight: 700;
	color: white;
	margin: 0 0 8px 0;
	display: flex;
	align-items: center;
	gap: 12px;
	text-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

.clearance-title i {
	font-size: 28px;
	opacity: 0.9;
}

.clearance-subtitle {
	color: rgba(255,255,255,0.9);
	font-size: 16px;
	margin: 0;
	font-weight: 400;
}

.status-section {
	display: flex;
	flex-direction: column;
	align-items: flex-end;
	gap: 12px;
}

.main-status {
	display: flex;
	align-items: center;
}

.status-badge {
	font-size: 15px;
	padding: 10px 20px;
	border-radius: 25px;
	animation: pulse 2s infinite;
	box-shadow: 0 4px 12px rgba(0,0,0,0.2);
	display: inline-flex;
	align-items: center;
	gap: 8px;
	font-weight: 600;
	backdrop-filter: blur(10px);
}

.risk-status {
	display: flex;
	align-items: center;
	gap: 10px;
	background: rgba(255,255,255,0.15);
	padding: 8px 16px;
	border-radius: 20px;
	backdrop-filter: blur(10px);
}

.risk-label {
	color: rgba(255,255,255,0.9);
	font-size: 13px;
	font-weight: 500;
}

.risk-badge {
	font-size: 13px;
	padding: 6px 14px;
	border-radius: 20px;
	box-shadow: 0 2px 8px rgba(0,0,0,0.15);
	display: inline-flex;
	align-items: center;
	gap: 6px;
	font-weight: 600;
}

@keyframes shimmer {
	0% { transform: rotate(0deg); }
	100% { transform: rotate(360deg); }
}

@keyframes pulse {
	0%, 100% { transform: scale(1); box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
	50% { transform: scale(1.05); box-shadow: 0 4px 12px rgba(0,0,0,0.15); }
}

.card {
	margin-bottom: 25px;
	border: none;
	border-radius: 16px;
	box-shadow: 0 2px 12px rgba(0,0,0,0.08);
	transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
	animation: fadeInUp 0.6s ease-out;
	animation-fill-mode: both;
	background: white;
	overflow: hidden;
	position: relative;
	margin-left: 30px;
	margin-right: 30px;
}

.risk-analysis-card {
	border-left: 4px solid #f59e0b;
	box-shadow: 0 4px 20px rgba(245, 158, 11, 0.15);
}

.card::before {
	content: '';
	position: absolute;
	top: 0;
	left: 0;
	right: 0;
	height: 4px;
	background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
	transform: scaleX(0);
	transform-origin: left;
	transition: transform 0.4s ease;
}

.card:hover::before {
	transform: scaleX(1);
}

.card:nth-child(1) { animation-delay: 0.1s; }
.card:nth-child(2) { animation-delay: 0.2s; }
.card:nth-child(3) { animation-delay: 0.3s; }

@keyframes fadeInUp {
	from { opacity: 0; transform: translateY(30px); }
	to { opacity: 1; transform: translateY(0); }
}

.card:hover {
	box-shadow: 0 8px 30px rgba(0,0,0,0.15);
	transform: translateY(-4px);
}

.modern-card-header {
	background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
	color: white;
	padding: 20px 24px;
	border-radius: 16px 16px 0 0;
	border: none;
	position: relative;
	overflow: hidden;
}

.modern-card-header::before {
	content: '';
	position: absolute;
	top: -50%;
	right: -50%;
	width: 200%;
	height: 200%;
	background: radial-gradient(circle, rgba(255,255,255,0.1) 0%, transparent 70%);
	animation: shimmer 3s infinite;
}

@keyframes shimmer {
	0% { transform: rotate(0deg); }
	100% { transform: rotate(360deg); }
}

.modern-card-header h5 {
	margin: 0;
	font-size: 18px;
	font-weight: 600;
	color: white;
	position: relative;
	z-index: 1;
}

.modern-card-header h5 i {
	margin-right: 8px;
	animation: iconPulse 2s infinite;
}

.card-header {
	background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
	color: white;
	padding: 18px 20px;
	border-radius: 16px 16px 0 0;
	border: none;
	position: relative;
	overflow: hidden;
}

.card-header::before {
	content: '';
	position: absolute;
	top: -50%;
	right: -50%;
	width: 200%;
	height: 200%;
	background: radial-gradient(circle, rgba(255,255,255,0.1) 0%, transparent 70%);
	animation: shimmer 3s infinite;
}

.card-header h5 {
	margin: 0;
	font-size: 18px;
	font-weight: 600;
	color: white;
	position: relative;
	z-index: 1;
}

.badge-info {
	background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
	color: white;
	border: 1px solid #1d4ed8;
	padding: 6px 12px;
	font-size: 12px;
	font-weight: 600;
	border-radius: 20px;
	box-shadow: 0 2px 6px rgba(59, 130, 246, 0.3);
}

.badge-success {
	background: linear-gradient(135deg, #10b981 0%, #059669 100%);
	color: white;
	border: 1px solid #047857;
}

.badge-warning {
	background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
	color: white;
	border: 1px solid #b45309;
}

.badge-danger {
	background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
	color: white;
	border: 1px solid #b91c1c;
}

.badge-secondary {
	background: linear-gradient(135deg, #6b7280 0%, #4b5563 100%);
	color: white;
	border: 1px solid #374151;
}

.invoice-link {
	color: #667eea;
	font-weight: 600;
	text-decoration: none;
	transition: all 0.3s ease;
	display: inline-flex;
	align-items: center;
	gap: 6px;
}

.invoice-link:hover {
	color: #764ba2;
	text-decoration: underline;
	transform: translateX(2px);
}

.invoice-link i {
	font-size: 14px;
}

/* Risk Analysis Section Styles */
.info-row {
	display: flex;
	justify-content: space-between;
	align-items: center;
	padding: 16px 0;
	border-bottom: 1px solid #e5e7eb;
}

.info-row:last-child {
	border-bottom: none;
}

.info-label {
	font-weight: 600;
	color: #4b5563;
	font-size: 14px;
	display: flex;
	align-items: center;
	gap: 8px;
}

.info-label i {
	color: #667eea;
	font-size: 16px;
}

.info-value {
	font-size: 16px;
	color: #1f2937;
	font-weight: 500;
}

.highlight-amount {
	font-size: 20px;
	font-weight: 700;
	color: #f59e0b;
	background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
	padding: 8px 16px;
	border-radius: 8px;
	display: inline-block;
}

/* Telegram-style Comment UI */
.telegram-comment-section {
	margin-top: 24px;
	padding-top: 24px;
	border-top: 2px solid #e5e7eb;
}

.comment-header {
	font-weight: 600;
	color: #4b5563;
	font-size: 14px;
	margin-bottom: 12px;
	display: flex;
	align-items: center;
	gap: 8px;
}

.comment-header i {
	color: #667eea;
	font-size: 16px;
}

.telegram-message {
	display: flex;
	flex-direction: column;
	gap: 8px;
}

.message-bubble {
	background: linear-gradient(135deg, #e0e7ff 0%, #c7d2fe 100%);
	border-radius: 18px 18px 18px 4px;
	padding: 16px 20px;
	box-shadow: 0 2px 8px rgba(102, 126, 234, 0.15);
	position: relative;
	max-width: 85%;
	animation: messageSlideIn 0.4s ease-out;
	margin-left: 0;
}

@keyframes messageSlideIn {
	from {
		opacity: 0;
		transform: translateX(-20px) scale(0.95);
	}
	to {
		opacity: 1;
		transform: translateX(0) scale(1);
	}
}

.message-bubble::before {
	content: '';
	position: absolute;
	left: -8px;
	bottom: 0;
	width: 0;
	height: 0;
	border-style: solid;
	border-width: 0 8px 12px 0;
	border-color: transparent #c7d2fe transparent transparent;
}

.message-content {
	color: #1e293b;
	font-size: 15px;
	line-height: 1.6;
	margin-bottom: 8px;
	word-wrap: break-word;
	white-space: pre-wrap;
}

.message-time {
	font-size: 11px;
	color: #64748b;
	display: flex;
	align-items: center;
	gap: 4px;
	margin-top: 4px;
	opacity: 0.7;
}

.message-time i {
	font-size: 10px;
}

/* Responsive adjustments */
@media (max-width: 768px) {
	.hero-header {
		padding: 30px 20px;
	}
	
	.hero-content {
		flex-direction: column;
		align-items: flex-start;
	}
	
	.status-section {
		align-items: flex-start;
		width: 100%;
	}
	
	.clearance-title {
		font-size: 24px;
	}
	
	.card {
		margin-left: 15px;
		margin-right: 15px;
	}
	
	.message-bubble {
		max-width: 95%;
	}
}

.back-button-container {
	padding: 30px;
	margin-top: 20px;
	border-top: 1px solid #e5e7eb;
	background: white;
}

.back-button-container .btn {
	font-size: 14px;
	padding: 12px 24px;
}

@keyframes iconPulse {
	0%, 100% { transform: scale(1); }
	50% { transform: scale(1.1); }
}

.card-body {
	padding: 25px;
}

.table-borderless td {
	border: none;
	padding: 14px 0;
	vertical-align: middle;
}

.table-borderless td:first-child {
	width: 40%;
	color: #6c757d;
	font-weight: 500;
}

.modern-table-wrapper {
	border-radius: 12px;
	overflow: hidden;
	box-shadow: 0 2px 12px rgba(0,0,0,0.05);
	background: white;
}

.modern-table {
	margin: 0;
	border-collapse: separate;
	border-spacing: 0;
	width: 100%;
	background: white;
}

.modern-table thead {
	background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
	position: relative;
}

.modern-table thead th {
	padding: 18px 16px;
	font-weight: 600;
	color: white;
	text-transform: uppercase;
	font-size: 11px;
	letter-spacing: 1px;
	border: none;
	position: relative;
}

.modern-table thead th:not(:last-child)::after {
	content: '';
	position: absolute;
	right: 0;
	top: 20%;
	height: 60%;
	width: 1px;
	background: rgba(255,255,255,0.3);
}

.modern-table tbody tr {
	transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
	border-bottom: 1px solid #e2e8f0;
	position: relative;
}

.modern-table tbody tr::before {
	content: '';
	position: absolute;
	left: 0;
	top: 0;
	bottom: 0;
	width: 4px;
	background: linear-gradient(180deg, #667eea 0%, #764ba2 100%);
	transform: scaleY(0);
	transform-origin: top;
	transition: transform 0.3s ease;
}

.modern-table tbody tr:hover::before {
	transform: scaleY(1);
}

.modern-table tbody tr:hover {
	background: linear-gradient(90deg, #f8fafc 0%, #f1f5f9 100%);
	transform: translateX(4px);
	box-shadow: 0 4px 12px rgba(0,0,0,0.08);
}

.modern-table tbody td {
	padding: 20px 16px;
	vertical-align: middle;
}

.document-row {
	animation: slideInLeft 0.5s ease-out;
	animation-fill-mode: both;
}

.document-row:nth-child(1) { animation-delay: 0.1s; }
.document-row:nth-child(2) { animation-delay: 0.2s; }
.document-row:nth-child(3) { animation-delay: 0.3s; }
.document-row:nth-child(4) { animation-delay: 0.4s; }
.document-row:nth-child(5) { animation-delay: 0.5s; }
.document-row:nth-child(6) { animation-delay: 0.6s; }

@keyframes slideInLeft {
	from { opacity: 0; transform: translateX(-30px); }
	to { opacity: 1; transform: translateX(0); }
}

.status-container {
	display: flex;
	flex-direction: column;
	gap: 6px;
	align-items: flex-start;
}

.badge {
	padding: 8px 14px;
	font-size: 12px;
	font-weight: 600;
	border-radius: 20px;
	display: inline-flex;
	align-items: center;
	gap: 6px;
	box-shadow: 0 2px 6px rgba(0,0,0,0.1);
	transition: all 0.3s ease;
	white-space: nowrap;
}

.badge:hover {
	transform: scale(1.05);
	box-shadow: 0 4px 12px rgba(0,0,0,0.15);
}

.animated-badge {
	animation: badgeFadeIn 0.5s ease-out;
}

@keyframes badgeFadeIn {
	from { opacity: 0; transform: scale(0.8); }
	to { opacity: 1; transform: scale(1); }
}

.badge i {
	font-size: 12px;
}

.badge-required {
	background: linear-gradient(135deg, #fee2e2 0%, #fecaca 100%);
	color: #991b1b;
	border: 1px solid #fca5a5;
}

.badge-optional {
	background: linear-gradient(135deg, #f3f4f6 0%, #e5e7eb 100%);
	color: #374151;
	border: 1px solid #d1d5db;
}

.badge-accepted {
	background: linear-gradient(135deg, #d1fae5 0%, #a7f3d0 100%);
	color: #065f46;
	border: 1px solid #6ee7b7;
	animation: successPulse 2s infinite;
}

@keyframes successPulse {
	0%, 100% { box-shadow: 0 2px 6px rgba(16, 185, 129, 0.2); }
	50% { box-shadow: 0 4px 12px rgba(16, 185, 129, 0.4); }
}

.badge-declined {
	background: linear-gradient(135deg, #fee2e2 0%, #fecaca 100%);
	color: #991b1b;
	border: 1px solid #fca5a5;
	animation: shake 0.5s, declinePulse 2s infinite 0.5s;
}

@keyframes shake {
	0%, 100% { transform: translateX(0); }
	25% { transform: translateX(-5px); }
	75% { transform: translateX(5px); }
}

@keyframes declinePulse {
	0%, 100% { box-shadow: 0 2px 6px rgba(239, 68, 68, 0.2); }
	50% { box-shadow: 0 4px 12px rgba(239, 68, 68, 0.4); }
}

.badge-review {
	background: linear-gradient(135deg, #dbeafe 0%, #bfdbfe 100%);
	color: #1e40af;
	border: 1px solid #93c5fd;
}

.badge-attached {
	background: linear-gradient(135deg, #d1fae5 0%, #a7f3d0 100%);
	color: #065f46;
	border: 1px solid #6ee7b7;
}

.badge-missing {
	background: linear-gradient(135deg, #fee2e2 0%, #fecaca 100%);
	color: #991b1b;
	border: 1px solid #fca5a5;
}

.badge-pending {
	background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
	color: #92400e;
	border: 1px solid #fcd34d;
}

.btn {
	border-radius: 10px;
	padding: 10px 18px;
	font-weight: 600;
	transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
	border: none;
	cursor: pointer;
	font-size: 13px;
	position: relative;
	overflow: hidden;
}

.btn::before {
	content: '';
	position: absolute;
	top: 50%;
	left: 50%;
	width: 0;
	height: 0;
	border-radius: 50%;
	background: rgba(255,255,255,0.3);
	transform: translate(-50%, -50%);
	transition: width 0.6s, height 0.6s;
}

.btn:hover::before {
	width: 300px;
	height: 300px;
}

.btn-view {
	background: linear-gradient(135deg, #10b981 0%, #059669 100%);
	color: white;
	box-shadow: 0 2px 8px rgba(16, 185, 129, 0.3);
}

.btn-view:hover {
	background: linear-gradient(135deg, #059669 0%, #047857 100%);
	transform: translateY(-2px);
	box-shadow: 0 6px 20px rgba(16, 185, 129, 0.4);
}

.btn-upload {
	background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
	color: white;
	box-shadow: 0 2px 8px rgba(102, 126, 234, 0.3);
}

.btn-upload:hover {
	transform: translateY(-2px);
	box-shadow: 0 6px 20px rgba(102, 126, 234, 0.5);
}

.btn-reupload {
	background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
	color: white;
	margin-top: 10px;
	display: block;
	width: 100%;
	box-shadow: 0 2px 8px rgba(245, 158, 11, 0.3);
	animation: reuploadPulse 2s infinite;
}

@keyframes reuploadPulse {
	0%, 100% { box-shadow: 0 2px 8px rgba(245, 158, 11, 0.3); }
	50% { box-shadow: 0 4px 16px rgba(245, 158, 11, 0.5); }
}

.btn-reupload:hover {
	background: linear-gradient(135deg, #d97706 0%, #b45309 100%);
	transform: translateY(-2px);
	box-shadow: 0 6px 20px rgba(245, 158, 11, 0.5);
}

.btn-secondary {
	background: linear-gradient(135deg, #6b7280 0%, #4b5563 100%);
	color: white;
	box-shadow: 0 2px 8px rgba(107, 114, 128, 0.3);
}

.btn-secondary:hover {
	background: linear-gradient(135deg, #4b5563 0%, #374151 100%);
	transform: translateY(-2px);
	box-shadow: 0 6px 20px rgba(107, 114, 128, 0.4);
	color: white;
	text-decoration: none;
}

.upload-container {
	display: flex;
	align-items: center;
	gap: 12px;
}

.upload-progress {
	color: #667eea;
	font-weight: 600;
	display: flex;
	align-items: center;
	gap: 8px;
}

.upload-progress i {
	animation: spin 1s linear infinite;
}

@keyframes spin {
	from { transform: rotate(0deg); }
	to { transform: rotate(360deg); }
}

.attachment-actions {
	display: flex;
	flex-direction: column;
	gap: 10px;
}

.file-name {
	color: #6b7280;
	font-size: 11px;
	margin-top: 4px;
	font-weight: 500;
	word-break: break-all;
}

.decline-reason-tooltip {
	margin-top: 6px;
}

.decline-reason-link {
	color: #dc2626;
	cursor: pointer;
	font-size: 11px;
	font-weight: 500;
	display: inline-flex;
	align-items: center;
	gap: 4px;
	transition: all 0.2s ease;
}

.decline-reason-link:hover {
	color: #991b1b;
	text-decoration: underline;
}

.mt-4 {
	margin-top: 2rem;
}

.sub-items {
	color: #4b5563;
	font-size: 13px;
	font-weight: 500;
}

.document-name {
	color: #1f2937;
	font-size: 15px;
	font-weight: 600;
}

/* Modal Styles */
.modal-content {
	border-radius: 16px;
	border: none;
	box-shadow: 0 20px 60px rgba(0,0,0,0.3);
	animation: modalFadeIn 0.3s ease-out;
}

@keyframes modalFadeIn {
	from { opacity: 0; transform: scale(0.9) translateY(-20px); }
	to { opacity: 1; transform: scale(1) translateY(0); }
}

.modal-header {
	background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
	color: white;
	border-radius: 16px 16px 0 0;
	padding: 24px;
	border-bottom: none;
}

.modal-header .close {
	color: white;
	opacity: 0.9;
	font-size: 28px;
	transition: all 0.2s ease;
}

.modal-header .close:hover {
	opacity: 1;
	transform: rotate(90deg);
}

.modal-body {
	padding: 30px;
}

.modal-footer {
	border-top: 1px solid #e5e7eb;
	padding: 20px 30px;
	background: #f9fafb;
	border-radius: 0 0 16px 16px;
}

/* Responsive Design */
@media (max-width: 768px) {
	.custom-clearance-detail-page {
		padding: 15px;
	}
	
	.modern-table-wrapper {
		overflow-x: auto;
	}
	
	.modern-table {
		min-width: 800px;
	}
}
</style>

<script>
let currentRowName = null;
let currentClearanceName = '{{ clearance.name }}';

// Initialize tooltips
$(document).ready(function() {
	$('[data-toggle="tooltip"]').tooltip();
	
	// Animate cards on load
	$('.card').each(function(index) {
		$(this).css('animation-delay', (index * 0.1) + 's');
	});
	
	// Animate table rows on load
	$('.document-row').each(function(index) {
		$(this).css('animation-delay', (index * 0.1) + 's');
	});
});

function showReuploadModal(button) {
	// Get data from button attributes
	const rowName = button.getAttribute('data-row-name');
	const docName = button.getAttribute('data-doc-name');
	const reason = button.getAttribute('data-reason') || '';
	
	currentRowName = rowName;
	document.getElementById('modal-doc-name').textContent = docName;
	
	// Reset file input
	document.getElementById('reupload-file-input').value = '';
	
	if (reason && reason.trim()) {
		document.getElementById('modal-reason-text').textContent = reason;
		document.getElementById('modal-decline-reason').style.display = 'block';
	} else {
		document.getElementById('modal-decline-reason').style.display = 'none';
	}
	
	$('#reuploadModal').modal('show');
	
	// Focus on file input after modal is shown
	setTimeout(function() {
		document.getElementById('reupload-file-input').focus();
	}, 300);
}

// Handle re-upload submit
document.addEventListener('DOMContentLoaded', function() {
	const reuploadBtn = document.getElementById('reupload-submit-btn');
	if (reuploadBtn) {
		reuploadBtn.addEventListener('click', function() {
			const fileInput = document.getElementById('reupload-file-input');
			if (!fileInput.files || !fileInput.files[0]) {
				frappe.show_alert({
					message: '{{ _("Please select a file to upload") }}',
					indicator: 'orange'
				}, 3);
				return;
			}
			
			// Disable button during upload
			reuploadBtn.disabled = true;
			reuploadBtn.innerHTML = '<i class="fa fa-spinner fa-spin"></i> {{ _("Uploading...") }}';
			
			uploadDocument(fileInput.files[0], currentRowName, true);
		});
	}
});

// Handle file uploads
document.addEventListener('DOMContentLoaded', function() {
	document.querySelectorAll('.file-input').forEach(input => {
		input.addEventListener('change', function() {
			if (this.files && this.files[0]) {
				const rowName = this.getAttribute('data-row-name');
				uploadDocument(this.files[0], rowName, false);
			}
		});
	});
});

function uploadDocument(file, rowName, isReupload) {
	// Show progress indicator
	const progressSpan = document.getElementById('progress-' + rowName);
	const row = document.querySelector(`tr[data-row-name="${rowName}"]`);
	
	if (progressSpan) {
		progressSpan.style.display = 'inline-flex';
	}
	
	if (isReupload) {
		// Hide re-upload button during upload
		const reuploadBtn = row.querySelector('.btn-reupload');
		if (reuploadBtn) {
			reuploadBtn.style.display = 'none';
		}
	} else {
		const uploadBtn = row.querySelector('.btn-upload');
		if (uploadBtn) {
			uploadBtn.style.display = 'none';
		}
	}
	
	// Validate file size (max 10MB)
	const maxSize = 10 * 1024 * 1024; // 10MB
	if (file.size > maxSize) {
		frappe.show_alert({
			message: '{{ _("File size exceeds 10MB limit. Please choose a smaller file.") }}',
			indicator: 'red'
		}, 5);
		resetUploadUI(rowName, isReupload);
		return;
	}
	
	// Validate file type
	const allowedTypes = ['.pdf', '.doc', '.docx', '.jpg', '.jpeg', '.png', '.gif', '.xlsx', '.xls'];
	const fileName = file.name.toLowerCase();
	const isValidType = allowedTypes.some(type => fileName.endsWith(type));
	
	if (!isValidType) {
		frappe.show_alert({
			message: '{{ _("Invalid file type. Please upload PDF, DOC, DOCX, JPG, PNG, GIF, or XLSX files.") }}',
			indicator: 'red'
		}, 5);
		resetUploadUI(rowName, isReupload);
		return;
	}
	
	const formData = new FormData();
	formData.append('file', file);
	formData.append('doctype', 'Custom Clearance');
	formData.append('docname', currentClearanceName);
	formData.append('folder', 'Home/Attachments');
	formData.append('is_private', '0');
	
	const xhr = new XMLHttpRequest();
	xhr.open('POST', '/api/method/upload_file', true);
	xhr.setRequestHeader('X-Frappe-CSRF-Token', frappe.csrf_token);
	
	// Show upload progress
	xhr.upload.addEventListener('progress', function(e) {
		if (e.lengthComputable) {
			const percentComplete = (e.loaded / e.total) * 100;
			if (progressSpan) {
				progressSpan.innerHTML = '<i class="fa fa-spinner fa-spin"></i> {{ _("Uploading...") }} ' + Math.round(percentComplete) + '%';
			}
		}
	});
	
	xhr.onload = function() {
		if (xhr.status === 200) {
			try {
				const response = JSON.parse(xhr.responseText);
				if (response.message && response.message.file_url) {
					frappe.call({
						method: 'custom_clearance.custom_clearance.doctype.custom_clearance.custom_clearance.update_document_attachment',
						args: {
							clearance_name: currentClearanceName,
							row_name: rowName,
							file_url: response.message.file_url,
							is_reupload: isReupload
						},
						callback: function(r) {
							if (r.message && r.message.success) {
								if (isReupload) {
									$('#reuploadModal').modal('hide');
									// Reset modal button
									const reuploadBtn = document.getElementById('reupload-submit-btn');
									if (reuploadBtn) {
										reuploadBtn.disabled = false;
										reuploadBtn.innerHTML = '<i class="fa fa-upload"></i> {{ _("Upload") }}';
									}
								}
								frappe.show_alert({
									message: isReupload ? '{{ _("Document re-uploaded successfully! It will be reviewed again.") }}' : '{{ _("Document uploaded successfully!") }}',
									indicator: 'green'
								}, 4);
								
								// Reload page after a short delay
								setTimeout(() => {
									window.location.reload();
								}, 1500);
							} else {
								showError(rowName, isReupload);
							}
						},
						error: function() {
							showError(rowName, isReupload);
						}
					});
				} else {
					showError(rowName, isReupload);
				}
			} catch (e) {
				console.error('Upload error:', e);
				showError(rowName, isReupload);
			}
		} else {
			showError(rowName, isReupload);
		}
	};
	
	xhr.onerror = function() {
		showError(rowName, isReupload);
	};
	
	xhr.send(formData);
}

function resetUploadUI(rowName, isReupload) {
	const progressSpan = document.getElementById('progress-' + rowName);
	const row = document.querySelector(`tr[data-row-name="${rowName}"]`);
	
	if (progressSpan) {
		progressSpan.style.display = 'none';
	}
	
	if (isReupload) {
		const reuploadBtn = row.querySelector('.btn-reupload');
		if (reuploadBtn) {
			reuploadBtn.style.display = 'block';
		}
		const reuploadModalBtn = document.getElementById('reupload-submit-btn');
		if (reuploadModalBtn) {
			reuploadModalBtn.disabled = false;
			reuploadModalBtn.innerHTML = '<i class="fa fa-upload"></i> {{ _("Upload") }}';
		}
	} else {
		const uploadBtn = row.querySelector('.btn-upload');
		if (uploadBtn) {
			uploadBtn.style.display = 'inline-block';
		}
	}
}

function showError(rowName, isReupload) {
	resetUploadUI(rowName, isReupload);
	frappe.show_alert({
		message: '{{ _("Error uploading file. Please try again.") }}',
		indicator: 'red'
	}, 5);
}

// Close modal on escape key
document.addEventListener('keydown', function(e) {
	if (e.key === 'Escape') {
		$('#reuploadModal').modal('hide');
	}
});
</script>
{% else %}
<div class="custom-clearances-page">
	<div class="page-header">
		<h2 class="page-title">{{ title or _("Custom Clearances") }}</h2>
		{% if customer_name %}
		<p class="text-muted">{{ _("Customer") }}: <strong>{{ customer_name }}</strong></p>
		{% endif %}
	</div>

	{% if no_customer %}
	<div class="alert alert-warning">
		{{ message }}
	</div>
	{% elif custom_clearances is defined and custom_clearances %}
	<div class="custom-clearances-list">
		<div class="table-responsive">
			<table class="table table-bordered table-hover">
				<thead class="thead-light">
					<tr>
						<th>{{ _("Clearance Number") }}</th>
						<th>{{ _("Date") }}</th>
						<th>{{ _("Shipping Type") }}</th>
						<th>{{ _("Status") }}</th>
						<th>{{ _("Amount") }}</th>
						<th>{{ _("Payment Status") }}</th>
						<th>{{ _("Payment Date") }}</th>
						<th>{{ _("Actions") }}</th>
					</tr>
				</thead>
				<tbody>
					{% for clearance in custom_clearances %}
					<tr>
						<td>
							<a href="/custom_clearances/{{ clearance.name }}" class="text-primary">
								{{ clearance.name }}
							</a>
						</td>
						<td>{{ frappe.format(clearance.clearance_date, {"fieldtype": "Date"}) }}</td>
						<td>
							<span class="badge badge-info">{{ clearance.shipping_type }}</span>
						</td>
						<td>
							{% set status_color = "secondary" %}
							{% if clearance.status == "Cleared" %}
								{% set status_color = "success" %}
							{% elif clearance.status == "Risk Analysis" %}
								{% set status_color = "primary" %}
							{% elif clearance.status == "In Review" %}
								{% set status_color = "info" %}
							{% elif clearance.status == "Document Submitting" %}
								{% set status_color = "secondary" %}
							{% endif %}
							<span class="badge badge-{{ status_color }}">{{ clearance.status }}</span>
							{% if clearance.status == "Risk Analysis" %}
								<br><small class="badge badge-{{ 'success' if clearance.risk_result == 'Green' else 'warning' if clearance.risk_result == 'Yellow' else 'danger'  }}">
									{{ clearance.risk_result }}
								</small>
							{% endif %}
						</td>
						<td>
							{% if clearance.amount %}
								{{ frappe.format(clearance.amount, {"fieldtype": "Currency"}) }}
							{% else %}
								-
							{% endif %}
						</td>
						<td>
							{% set payment_color = "secondary" %}
							{% if clearance.payment_status == "Paid" %}
								{% set payment_color = "success" %}
							{% elif clearance.payment_status == "Partially Paid" %}
								{% set payment_color = "warning" %}
							{% endif %}
							<span class="badge badge-{{ payment_color }}">
								{{ clearance.payment_status or _("Pending") }}
							</span>
						</td>
						<td>
							{% if clearance.payment_date %}
								{{ frappe.format(clearance.payment_date, {"fieldtype": "Date"}) }}
							{% else %}
								-
							{% endif %}
						</td>
						<td>
							<a href="/custom_clearances/{{ clearance.name }}" class="btn btn-sm btn-primary">
								{{ _("View") }}
							</a>
							{% if clearance.sales_invoice %}
							<a href="/invoices/{{ clearance.sales_invoice }}" class="btn btn-sm btn-info">
								{{ _("Invoice") }}
							</a>
							{% endif %}
						</td>
					</tr>
					{% endfor %}
				</tbody>
			</table>
		</div>
	</div>
	{% else %}
	<div class="alert alert-info">
		{{ _("No custom clearances found.") }}
	</div>
	{% endif %}
</div>

<style>
.custom-clearances-page {
	padding: 30px;
	min-height: 100vh;
	animation: fadeIn 0.5s ease-in;
}

.page-header {
	margin-bottom: 30px;
	animation: slideDown 0.6s ease-out;
}

.page-title {
	font-size: 28px;
	font-weight: 700;
	margin-bottom: 10px;
	color: #1f2937;
	text-shadow: 0 2px 4px rgba(0,0,0,0.05);
}

.custom-clearances-list {
	margin-top: 20px;
}

.table-responsive {
	border-radius: 16px;
	overflow: hidden;
	box-shadow: 0 4px 20px rgba(0,0,0,0.1);
	background: white;
}

.table {
	background-color: white;
	margin: 0;
	border-collapse: separate;
	border-spacing: 0;
}

.table thead {
	background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
}

.table thead th {
	background: transparent;
	font-weight: 600;
	border: none;
	color: white;
	padding: 18px 16px;
	text-transform: uppercase;
	font-size: 11px;
	letter-spacing: 1px;
	position: relative;
}

.table thead th:not(:last-child)::after {
	content: '';
	position: absolute;
	right: 0;
	top: 20%;
	height: 60%;
	width: 1px;
	background: rgba(255,255,255,0.3);
}

.table tbody tr {
	transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
	border-bottom: 1px solid #e2e8f0;
	animation: fadeInRow 0.5s ease-out;
	animation-fill-mode: both;
}

.table tbody tr:nth-child(1) { animation-delay: 0.1s; }
.table tbody tr:nth-child(2) { animation-delay: 0.2s; }
.table tbody tr:nth-child(3) { animation-delay: 0.3s; }
.table tbody tr:nth-child(4) { animation-delay: 0.4s; }
.table tbody tr:nth-child(5) { animation-delay: 0.5s; }

@keyframes fadeInRow {
	from { opacity: 0; transform: translateY(10px); }
	to { opacity: 1; transform: translateY(0); }
}

.table tbody tr:hover {
	background: linear-gradient(90deg, #f8fafc 0%, #f1f5f9 100%);
	transform: translateX(4px);
	box-shadow: 0 2px 8px rgba(0,0,0,0.05);
}

.table tbody td {
	padding: 16px;
	vertical-align: middle;
}

.badge {
	padding: 6px 12px;
	font-size: 12px;
	font-weight: 600;
	border-radius: 20px;
	display: inline-flex;
	align-items: center;
	gap: 4px;
	box-shadow: 0 2px 4px rgba(0,0,0,0.1);
	transition: all 0.2s ease;
}

.badge:hover {
	transform: scale(1.05);
}

.btn-sm {
	padding: 8px 16px;
	font-size: 12px;
	margin-right: 8px;
	border-radius: 8px;
	font-weight: 600;
	transition: all 0.3s ease;
	border: none;
	box-shadow: 0 2px 6px rgba(0,0,0,0.1);
}

.btn-sm:hover {
	transform: translateY(-2px);
	box-shadow: 0 4px 12px rgba(0,0,0,0.15);
}

.btn-primary {
	background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
	color: white;
}

.btn-primary:hover {
	background: linear-gradient(135deg, #5568d3 0%, #6a3d8f 100%);
}

.btn-info {
	background: linear-gradient(135deg, #06b6d4 0%, #0891b2 100%);
	color: white;
}

.btn-info:hover {
	background: linear-gradient(135deg, #0891b2 0%, #0e7490 100%);
}

.alert {
	border-radius: 12px;
	border: none;
	box-shadow: 0 2px 8px rgba(0,0,0,0.1);
	padding: 20px;
	animation: fadeInUp 0.5s ease-out;
}
</style>
{% endif %}
{% endblock %}
